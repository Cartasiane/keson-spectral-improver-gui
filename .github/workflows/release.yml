name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  release:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            args: --target aarch64-apple-darwin
          - platform: macos-15-intel
            args: --target x86_64-apple-darwin
          - platform: ubuntu-22.04
            args: ""
          - platform: windows-latest
            args: ""

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-15-intel' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: "./src-tauri -> target"

      - name: Install dependencies (Ubuntu)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libasound2-dev libfuse2

          # Download static ffprobe for Linux (ffmpeg not needed)
          wget https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-linux64-gpl.tar.xz
          tar xf ffmpeg-master-latest-linux64-gpl.tar.xz

          # Create binaries directory and copy ffprobe only
          mkdir -p src-tauri/binaries
          cp ffmpeg-master-latest-linux64-gpl/bin/ffprobe src-tauri/binaries/ffprobe-x86_64-unknown-linux-gnu

      - name: Install dependencies (Windows)
        if: matrix.platform == 'windows-latest'
        run: |
          # Download ffprobe for Windows (ffmpeg not needed)
          Invoke-WebRequest -Uri "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl.zip" -OutFile "ffmpeg.zip"
          Expand-Archive -Path "ffmpeg.zip" -DestinationPath "ffmpeg-temp"

          # Copy ffprobe only to binaries directory
          New-Item -ItemType Directory -Force -Path src-tauri/binaries | Out-Null
          Copy-Item "ffmpeg-temp/ffmpeg-master-latest-win64-gpl/bin/ffprobe.exe" -Destination "src-tauri/binaries/ffprobe-x86_64-pc-windows-msvc.exe"
        shell: powershell

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install LLVM (macOS)
        if: matrix.platform == 'macos-latest' || matrix.platform == 'macos-15-intel'
        run: |
          brew install llvm@15
          LLVM_PATH=$(brew --prefix llvm@15)
          echo "LLVM_DIR=$LLVM_PATH" >> $GITHUB_ENV
          echo "CMAKE_PREFIX_PATH=$LLVM_PATH" >> $GITHUB_ENV
          echo "LLVM_CONFIG=$LLVM_PATH/bin/llvm-config" >> $GITHUB_ENV
          echo "$LLVM_PATH/bin" >> $GITHUB_PATH

      - name: Build whatsmybitrate sidecar
        run: |
          cd vendor/whatsmybitrate
          export MACOSX_DEPLOYMENT_TARGET=10.13
          pip install pyinstaller
          pip install -r requirements.txt
          pyinstaller whatsmybitrate.spec

          # Prepare resources directory
          mkdir -p ../../src-tauri/resources/whatsmybitrate

          # Apply ad-hoc signature to the main binary inside the bundle (macOS only)
          if [[ "${{ matrix.platform }}" == "macos-latest" || "${{ matrix.platform }}" == "macos-15-intel" ]]; then
             codesign --force --sign - --entitlements entitlements.plist --options runtime dist/whatsmybitrate/whatsmybitrate
          fi

          # Copy the entire onedir content to resources
          cp -r dist/whatsmybitrate/* ../../src-tauri/resources/whatsmybitrate/
        shell: bash

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install frontend dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build

      - name: Enable updater capability (production only)
        run: |
          mv src-tauri/capabilities/updater.json.disabled src-tauri/capabilities/updater.json
        shell: bash

      - name: Build and release
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
          APPIMAGE_EXTRACT_AND_RUN: "1"
          NO_CLEANUP: "1"
        with:
          tagName: ${{ github.ref_name }}
          releaseName: "Keson Spectral Improver ${{ github.ref_name }}"
          releaseBody: "Voir les assets pour télécharger et installer cette version."
          releaseDraft: false
          prerelease: false
          args: ${{ matrix.args }} --features with-updater
